<!-- Template inheritance: this template is the parent, while others are the children-->
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  {% block tags %}{% endblock %}
  <link rel="stylesheet" type="text/css" href="{{ url_for ('static', filename = 'main.css')}}">
  {% if title %}
  <title>{{company_name|e}} - {{ title|e }} </title>
  {% else %}
  <title>{{company_name|e}} </title>
  {% endif %}
  <script>
    document.cookie = "time_zone=" + Intl.DateTimeFormat().resolvedOptions().timeZone;
  </script>
  <link rel="icon" type="image/png" href="/static/images/Favicon.png" />
</head>

<body>
  <header>
    <nav class="header-navbar-container">
      <a class="home-link" href="/">{{company_name|e}}</a>
      <div class="hamburger">
        <img onclick="hamburgerToggle()" class="icon" src="{{ url_for ('static', filename = 'icons/menu-icon.svg')}}"
          alt="Hamburger Icon">
      </div>
      <div id="nav-id" class="header-navigation">
        <div class="main-nav-links">
          <a class="header-link" href="/about">About Us </a>
          <a class="header-link" href="/products">Products</a>
          <a class="header-link" href="/forums">Forums</a>
          <a class="header-link" href="/blog">Blog</a>
          <a class="header-link" href="/tickets?status=all">Tickets</a>
          <a class="header-link" href="/calendar">Calendar</a>
          {% if is_admin %}
          <div class="dropdown">
            <div class="dropdown-btn">Tools</div>
            <div class="dropdown-content">
              <a href="/company/editor">Company</a>
              <a href="/orders/editor">Orders</a>
              <a href="/customers/editor">Customers</a>
              <a href="/blog/create">New Blog</a>
            </div>
          </div>
          {% endif %}
        </div>
        <div class="main-nav-links">
          {% if current_user.is_authenticated %}
          <a class="header-link" href="/profile">Profile</a>
          <a class="header-link" href="{{ url_for('auth.logout') }}">Logout</a>
          {% endif %}
          {% if not current_user.is_authenticated %}
          <a class="header-link" href="/login">Login</a>
          <a class="header-link" href="/signup">Sign Up</a>
          {% endif %}
        </div>
      </div>
    </nav>
  </header>
  <main>

    {% block content %}{% endblock %}
    <div id="message-layout">
      {% include "message/overlay.html" %}
    </div>
  </main>
  <footer>
    <p>Tobu Pengin {{copyright|e}}</p>
    {# if chat_bool #}
    {% include "message/chatbutton.html" %}
    {# endif #}
  </footer>

  <script src="{{ url_for ('static', filename = 'javascript/scripts.js')}}"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
    integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
    crossorigin="anonymous"></script>
  <script type="text/javascript">
    {#const socket = io();#}
    const socketio = io();
    const sent_messages = document.querySelector(".message-display-sender");
    const received_messages = document.querySelector(".message-display-receiver");
    const message_holder = $("#message-display")[0];
    let room_id = "";

    const selectRoomButtons = $(".btn-select-room");
    for (const button of selectRoomButtons) {
        button.addEventListener("click", function () {
            const other_user = this.dataset.otherUser;
            console.log("event listener with other_user " + other_user)
            selectRoom(other_user)
        });
    }
    function selectRoom(other_user) {
        $('div.message-display-sender').empty();
        $("div.message-display-receiver").empty();
        sent_messages.content = document.querySelector(".message-display-sender");
        received_messages.content = document.querySelector(".message-display-receiver");

        {#socket.emit('user selected', {#}
        {#  other_user: user_picked#}
        {# })#}
        console.log("about to join room with " + other_user)
        socketio.emit("join_room", { other_user: other_user });
    }

    function createMessage(message) {

        const isSender = message.author_name === "{{current_user.name}}";

        const msgSection = document.createElement('div');
        const newMessage = document.createElement('div');
        const msgSpace = document.createElement('div');
        msgSection.className = "text-section";
        newMessage.innerHTML = message.content;
        if (isSender) {
            newMessage.className = "text-section-s"
            msgSpace.className = "text-section-s";

            msgSection.appendChild(newMessage)
            msgSection.appendChild(msgSpace)
            sent_messages.appendChild(msgSection)
        } else {
            newMessage.className = "text-section-r"
            msgSpace.className = "text-section-r";

            msgSection.appendChild(msgSpace)
            msgSection.appendChild(newMessage)
            received_messages.appendChild(msgSection)
        }
    }


    {# Send message to the server #}
    function sendMessage() {
        const message = $("#message")[0];
        if (message.value === "") return;
        socketio.emit("save_message", { author_id: "{{current_user.id}}", content: message.value, room_id: room_id});
        message.value = "";
    }

    {# Listening for saved data from the server #}
    socketio.on('saved_message', (message) => {
        {# Not sure we need to loop through messages here, this event should not be called to load more than one message#}
        {#if (messages !== []) {#}
        {#    for (message of messages) {#}
        {#        createMessage({author_name: message.author_name, content: message.content, timestamp: message.timestamp});#}
        {#    }#}
        {# }#}

        {# Trigger function to add message in page #}
        console.log("create message:")
        console.log("author_name: " + message.author_name)
        console.log("content: " + message.content)
        console.log("timestamp: " + message.timestamp)
        console.log("current user: " + "{{current_user.name}}")
        createMessage({author_name: message.author_name, content: message.content, timestamp: message.timestamp});
    });

    socketio.on('joined_message', data => {
        console.log(data)
        console.log(data.message)
        room_id = data.room_id;
        {# Trigger function to add message in page #}
    });

    {#socket.on('connect', function () {#}
    {#  console.log("We have a new connection!")#}
    {##}
    {#  const chatForm = $('#chat-form').on('submit', function (e) {#}
    {#    e.preventDefault()#}
    {#    let display_name = $('input.display_name').val()#}
    {#    let message_text = $('textarea.message_text').val()#}
    {##}
    {#    socket.emit('message sent', {#}
    {#      chat_name: display_name,#}
    {#      chat_message: message_text#}
    {#    })#}
    {#    $('textarea.message_text').val('').focus()#}
    {#  })#}
    {##}
    {##}
    {#  const userPick = $('#chat-with-user').on("click", ".other-chat-user", function (e) {#}
    {#    e.preventDefault()#}
    {#    const user_picked = $(this).val();#}
    {#    //empty the chat box messages#}
    {#    $('div.message-display-sender').empty();#}
    {#    $("div.message-display-receiver").empty();#}
    {#    sent_messages.content = document.querySelector(".message-display-sender");#}
    {#    received_messages.content = document.querySelector(".message-display-receiver");#}
    {##}
    {#    socket.emit('user selected', {#}
    {#      other_user: user_picked#}
    {#    })#}
    {##}
    {#  })#}
    {##}
    {# })#}
    {##}
    {##}
    {##}
    {##}
    {#function createMessageSender(message) {#}
    {##}
    {#  const msgSection = document.createElement('div');#}
    {#  msgSection.className = "text-section";#}
    {#  const newMessage = document.createElement('div');#}
    {#  newMessage.className = "text-section-s"#}
    {#  newMessage.innerHTML = message.content;#}
    {#  const msgSpace = document.createElement('div');#}
    {#  msgSpace.className = "text-section-s";#}
    {##}
    {##}
    {#  msgSection.appendChild(newMessage)#}
    {#  msgSection.appendChild(msgSpace)#}
    {#  sent_messages.appendChild(msgSection)#}
    {##}
    {# }#}
    {##}
    {##}
    {#function createMessageReceiver(message) {#}
    {##}
    {#  const msgSection = document.createElement('div');#}
    {#  msgSection.className = "text-section";#}
    {##}
    {#  const msgSpace = document.createElement('div');#}
    {#  msgSpace.className = "text-section-r";#}
    {##}
    {##}
    {#  const newMessage = document.createElement('div');#}
    {#  newMessage.className = "text-section-r"#}
    {#  newMessage.innerHTML = message.content;#}
    {##}
    {#  msgSection.appendChild(msgSpace)#}
    {#  msgSection.appendChild(newMessage)#}
    {#  received_messages.appendChild(msgSection)#}
    {##}
    {# }#}
    {##}
    {##}
    {##}
    {#socket.on('load chat', function (message) {#}
    {#  console.log(message.content)#}
    {#  console.log($('input.display_name').val())#}
    {#  console.log(message.author_name)#}
    {#  if (message.author_name == $('input.display_name').val()) {#}
    {#    createMessageSender(message)#}
    {#  }#}
    {#  else {#}
    {#    createMessageReceiver(message)#}
    {#  }#}
    {# });#}
    {##}
    {##}
    {#socket.on('update chat', function (data) {#}
    {#  console.log(data)#}
    {#  console.log($('input.display_name').val())#}
    {#  if (data.chat_name == $('input.display_name').val()) {#}
    {#    createMessageSender(data)#}
    {#  }#}
    {#  else {#}
    {#    createMessageReceiver(data)#}
    {#  }#}
    {# });#}



  </script>

  {% for msg in messages %}
    <script type="text/javascript">
        createMessage({author_name: "{{msg.author_name}}", content: "{{msg.content}}", timestamp: "{{msg.timestamp}}"});
    </script>
    {% endfor %}

  {% block captchaScript %} {% endblock %}
</body>

</html>