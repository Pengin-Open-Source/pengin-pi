<!-- Template inheritance: this template is the parent, while others are the children-->
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  {% block tags %}{% endblock %}
  <link rel="stylesheet" type="text/css" href="{{ url_for ('static', filename = 'main.css')}}">
  {% if title %}
  <title>{{company_name|e}} - {{ title|e }} </title>
  {% else %}
  <title>{{company_name|e}} </title>
  {% endif %}
  <script>
    document.cookie = "time_zone=" + Intl.DateTimeFormat().resolvedOptions().timeZone;
  </script>
  <link rel="icon" type="image/png" href="/static/images/Favicon.png" />
</head>

<body>
  <header>
    <nav class="header-navbar-container">
      <a class="home-link" href="/">{{company_name|e}}</a>
      <div class="hamburger">
        <img onclick="hamburgerToggle()" class="icon" src="{{ url_for ('static', filename = 'icons/menu-icon.svg')}}"
          alt="Hamburger Icon">
      </div>
      <div id="nav-id" class="header-navigation">
        <div class="main-nav-links">
          <a class="header-link" href="/about">About Us </a>
          <a class="header-link" href="/products">Products</a>
          <a class="header-link" href="/forums">Forums</a>
          <a class="header-link" href="/blog">Blog</a>
          <a class="header-link" href="/tickets?status=all">Tickets</a>
          <a class="header-link" href="/calendar">Calendar</a>
          {% if is_admin %}
          <div class="dropdown">
            <div class="dropdown-btn">Tools</div>
            <div class="dropdown-content">
              <a href="/company/editor">Company</a>
              <a href="/orders/editor">Orders</a>
              <a href="/customers/editor">Customers</a>
              <a href="/blog/create">New Blog</a>
            </div>
          </div>
          {% endif %}
        </div>
        <div class="main-nav-links">
          {% if current_user.is_authenticated %}
          <a class="header-link" href="/profile">Profile</a>
          <a class="header-link" href="{{ url_for('auth.logout') }}">Logout</a>
          {% endif %}
          {% if not current_user.is_authenticated %}
          <a class="header-link" href="/login">Login</a>
          <a class="header-link" href="/signup">Sign Up</a>
          {% endif %}
        </div>
      </div>
    </nav>
  </header>
  <main>

    {% block content %}{% endblock %}
    <div id="message-layout">
      {% include "chat_overlay/overlay.html" %}
    </div>
  </main>
  <footer>
    <p>Tobu Pengin {{copyright|e}}</p>
    {# if chat_bool #}
    {% include "chat_overlay/chatbutton.html" %}
    {# endif #}
  </footer>

  <script src="{{ url_for ('static', filename = 'javascript/scripts.js')}}"></script>
  <script src="{{ url_for ('static', filename = 'javascript/jquery/1.12.4/jquery.min.js')}}"></script>
  <script src="{{ url_for ('static', filename = 'javascript/socket.io/4.0.1/socket.io.js')}}"></script>
  <script type="text/javascript">
    const socket = io();
    const sent_messages = document.querySelector(".message-display-sender");
    const received_messages = document.querySelector(".message-display-receiver");
    const user_section = document.querySelector("#user-section");
    const group_section = document.querySelector("#group-section");
    const inChatUserHeader = document.getElementById("users-per-chat-head")
    const inChatUsers = document.getElementById("users-in-chat")

    socket.on('connect', function () {
      console.log("We have a new connection!")

      const chatForm = $('#chat-form').on('submit', function (e) {
        e.preventDefault()
        let display_name = "{{current_user.name}}"
        let message_text = $('textarea.message_text').val()

        socket.emit('message sent', {
          chat_name: display_name,
          content: message_text
        })
        $('textarea.message_text').val('').focus()
      })


      const userPick = $('#chat-with-user').on("click", ".other-chat-user", function (e) {
        e.preventDefault()
        const user_picked = $(this).val();
        sent_messages.content = document.querySelector(".message-display-sender");
        received_messages.content = document.querySelector(".message-display-receiver");

        socket.emit('user selected', {
          other_user: user_picked
        })

      })


      const groupPick = $('#chat-with-group').on("click", ".chat-group", function (e) {
        e.preventDefault()
        const group_picked = $(this).val();
        sent_messages.content = document.querySelector(".message-display-sender");
        received_messages.content = document.querySelector(".message-display-receiver");
        socket.emit('room selected', {
          room_name: group_picked
        })

      })

    })


    function createMessageSender(message) {

      const msgSection = document.createElement('div');
      msgSection.className = "text-section";
      const newMessage = document.createElement('div');
      newMessage.className = "text-section-s"
      newMessage.innerHTML = message.content;
      const msgSpace = document.createElement('div');
      msgSpace.className = "text-section-s";


      msgSection.appendChild(newMessage)
      msgSection.appendChild(msgSpace)
      sent_messages.appendChild(msgSection)

    }


    function createMessageReceiver(message) {

      const msgSection = document.createElement('div');
      msgSection.className = "text-section";

      const msgSpace = document.createElement('div');
      msgSpace.className = "text-section-r";


      const newMessage = document.createElement('div');
      newMessage.className = "text-section-r"
      newMessage.innerHTML = message.content;

      msgSection.appendChild(msgSpace)
      msgSection.appendChild(newMessage)
      received_messages.appendChild(msgSection)

    }


    socket.on('load chat', function (messages) {

      sent_messages.innerHTML = "";
      received_messages.innerHTML = "";
      const msgList = JSON.parse(messages);

      msgList.forEach(message => {
        if (message.author_name === "{{current_user.name}}") {
          createMessageSender(message)
        }
        else {
          createMessageReceiver(message)
        }

      });

    });

    socket.on('users in group', function (data) {
      const chatting = JSON.parse(data);
      inChatUserHeader.innerHTML = "In Chat Room:  " + chatting[0].room_name
      inChatUsers.innerHTML = ""
      roomSelected()
      chatting.forEach(item => {
        const userName = item.user_name;
        const chatUser = document.createElement('div');
        chatUser.className = "message-grid-item";
        chatUser.innerHTML = item.user_name
        inChatUsers.appendChild(chatUser)
      });

    });

    socket.on('update chat', function (data) {
      if (data.chat_name === "{{current_user.name}}") {
        createMessageSender(data)
      }
      else {
        createMessageReceiver(data)
      }
    });



  </script>


  {% block captchaScript %} {% endblock %}
</body>

</html>